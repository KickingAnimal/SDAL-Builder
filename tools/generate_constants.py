import os
import pathlib
import sys

# ==============================================================================
# –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø
# ==============================================================================
# –ò–º—è —Ñ–∞–π–ª–∞, –∏–∑ –∫–æ—Ç–æ—Ä–æ–≥–æ –º—ã –∏–∑–≤–ª–µ–∫–∞–µ–º –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É (–≤–∞—à–∞ —Ä–∞–±–æ—á–∞—è –∫–æ–ø–∏—è)
SOURCE_FILE_NAME = "INIT.SDL" 
# –ü—É—Ç—å, –∫—É–¥–∞ –±—É–¥–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω —Ñ–∞–π–ª –∫–æ–Ω—Å—Ç–∞–Ω—Ç.
# –ü—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ–º, —á—Ç–æ –æ–Ω –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ src/sdal_builder/
TARGET_FILE_PATH = pathlib.Path("src") / "sdal_builder" / "init_constants.py"
# –ú–∞—Ä–∫–µ—Ä, –∫–æ—Ç–æ—Ä—ã–π –ø—Ä–µ–¥—à–µ—Å—Ç–≤—É–µ—Ç –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–æ–º—É —Å–ø–∏—Å–∫—É —Ñ–∞–π–ª–æ–≤ (Benelux1.SDL)
SPLIT_MARKER_START = b"BENELUX1.SDL"
# ==============================================================================

def extract_and_create_constant():
    """
    –ß–∏—Ç–∞–µ—Ç INIT.SDL, –∏–∑–≤–ª–µ–∫–∞–µ—Ç —Å—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏ –∑–∞–ø–∏—Å—ã–≤–∞–µ—Ç –µ–≥–æ –≤
    init_constants.py –≤ —Ñ–æ—Ä–º–∞—Ç–µ Python bytes-–∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã.
    """
    # 1. –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞–ª–∏—á–∏—è –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞
    if not pathlib.Path(SOURCE_FILE_NAME).exists():
        print(f"‚ùå –û—à–∏–±–∫–∞: –ò—Å—Ö–æ–¥–Ω—ã–π —Ñ–∞–π–ª '{SOURCE_FILE_NAME}' –Ω–µ –Ω–∞–π–¥–µ–Ω.")
        print("–£–±–µ–¥–∏—Ç–µ—Å—å, —á—Ç–æ –≤—ã –∑–∞–ø—É—Å—Ç–∏–ª–∏ —Å–∫—Ä–∏–ø—Ç –≤ –ø–∞–ø–∫–µ —Å —Ä–∞–±–æ—á–∏–º INIT.SDL.")
        sys.exit(1)

    print(f"[–ò–ù–§–û] –ß—Ç–µ–Ω–∏–µ –∏—Å—Ö–æ–¥–Ω–æ–≥–æ —Ñ–∞–π–ª–∞: {SOURCE_FILE_NAME}")

    try:
        with open(SOURCE_FILE_NAME, "rb") as f:
            full_content = f.read()

        # 2. –ü–æ–∏—Å–∫ —Ç–æ—á–∫–∏ —Ä–∞–∑–¥–µ–ª–µ–Ω–∏—è
        dynamic_list_start_pos = full_content.find(SPLIT_MARKER_START)

        if dynamic_list_start_pos == -1:
            print(f"‚ùå –û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –Ω–∞–π—Ç–∏ –º–∞—Ä–∫–µ—Ä '{SPLIT_MARKER_START.decode()}' –≤ {SOURCE_FILE_NAME}.")
            print("–í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ —Ñ–∞–π–ª, –Ω–µ –ø—Ä–µ–¥–Ω–∞–∑–Ω–∞—á–µ–Ω–Ω—ã–π –¥–ª—è OEM-—Å–±–æ—Ä–∫–∏.")
            sys.exit(1)
            
        # 3. –ò–∑–≤–ª–µ—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –±–ª–æ–∫–∞
        static_header_bytes = full_content[:dynamic_list_start_pos]
        
        # 4. –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –¥–ª—è –∑–∞–ø–∏—Å–∏ –≤ Python-—Ñ–∞–π–ª
        # repr() –ø—Ä–µ–æ–±—Ä–∞–∑—É–µ—Ç –±–∞–π—Ç—ã –≤ –±–µ–∑–æ–ø–∞—Å–Ω—É—é —Å—Ç—Ä–æ–∫—É b'...'
        constant_value = f"OEM_INIT_HEADER = {repr(static_header_bytes)}\n"
        
        # 5. –ó–∞–ø–∏—Å—å –≤ —Ü–µ–ª–µ–≤–æ–π —Ñ–∞–π–ª
        TARGET_FILE_PATH.parent.mkdir(parents=True, exist_ok=True)
        with open(TARGET_FILE_PATH, "w") as f_out:
            f_out.write("# WARNING: This file is automatically generated by create_init_constant.py\n")
            f_out.write("# It contains the static header block required for OEM INIT.SDL generation.\n")
            f_out.write(constant_value)

        print(f"‚úÖ –£—Å–ø–µ—Ö! –°—Ç–∞—Ç–∏—á–µ—Å–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ –∏–∑–≤–ª–µ—á–µ–Ω ({len(static_header_bytes)} –±–∞–π—Ç).")
        print(f"üíæ –§–∞–π–ª –∫–æ–Ω—Å—Ç–∞–Ω—Ç —Å–æ–∑–¥–∞–Ω/–æ–±–Ω–æ–≤–ª–µ–Ω: {TARGET_FILE_PATH}")
        print("\n–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –∑–∞–ø—É—Å—Ç–∏—Ç—å –æ—Å–Ω–æ–≤–Ω–æ–π –±–∏–ª–¥, –∏—Å–ø–æ–ª—å–∑—É—è —ç—Ç—É –∫–æ–Ω—Å—Ç–∞–Ω—Ç—É.")

    except Exception as e:
        print(f"‚ùå –ö—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ: {e}")
        sys.exit(1)

if __name__ == "__main__":
    extract_and_create_constant()